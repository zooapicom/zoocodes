# =============================================================================
# Zoo Docker Compose 配置（客户使用）
# 用途：分发给客户的部署配置
# =============================================================================

version: '3.8'

services:
  # MySQL 数据库服务（可选）
  # 如果定义了此服务，应用程序会自动连接到此 MySQL
  # 如果未定义，应用程序将使用配置文件中的 MySQL 配置
  mysql:
    image: mysql:8
    container_name: zoo-mysql
    restart: unless-stopped
    command: --mysql-native-password=ON --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    volumes:
      # 数据持久化
      - ./data/mysql:/var/lib/mysql
      # 可选：初始化脚本目录
      - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
    environment:
      TZ: ${TZ:-Asia/Shanghai}
      # MySQL root 密码（可通过环境变量或 .env 文件覆盖）
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD:-root123456}
      # 业务数据库配置（与 zoo 服务使用相同的环境变量源）
      # 这些变量会被 zoo 服务读取，确保配置一致性
      MYSQL_DATABASE: ${MYSQL_DATABASE:-zoo}
      MYSQL_USER: ${MYSQL_USER:-zoo}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD:-zoo123456}
    ports:
      # 可选：如果需要从主机访问，取消注释
      # - "${MYSQL_PORT:-3306}:3306"
    networks:
      - zoo-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis 缓存服务（可选）
  # 如果定义了此服务，应用程序会自动连接到此 Redis
  # 如果未定义，应用程序将使用配置文件中的 Redis 配置
  redis:
    image: redis:latest
    container_name: zoo-redis
    restart: unless-stopped
    command: redis-server --appendonly yes
    # 如果需要 Redis 密码，取消注释并修改密码
    # command: redis-server --requirepass ${REDIS_PASSWORD} --appendonly yes
    volumes:
      # 数据持久化
      - ./data/redis:/data
    environment:
      TZ: ${TZ:-Asia/Shanghai}
    ports:
      # 可选：如果需要从主机访问，取消注释
      # - "${REDIS_PORT:-6379}:6379"
    networks:
      - zoo-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Zoo 主服务（前后端一体）
  zoo:
    # 使用 Docker Hub 镜像（推荐）
    image: zooapi/zoocodes:latest
    
    container_name: zoo-app
    restart: unless-stopped
    ports:
      - "${ZOO_PORT:-8599}:8599"
    volumes:
      # 挂载配置文件（可自定义）
      - ./configs:/app/configs:ro
      # 挂载日志目录
      - ./logs:/app/logs
    environment:
      # 设置时区
      - TZ=${TZ:-Asia/Shanghai}
      # MySQL 配置（传递给启动脚本，仅在检测到 MySQL 服务时使用）
      # ⚠️ 注意：这些变量与上方 mysql 服务使用相同的环境变量源（MYSQL_USER、MYSQL_PASSWORD等）
      #    确保配置一致性。可通过 .env 文件或环境变量统一配置：
      #    MYSQL_USER=myuser MYSQL_PASSWORD=mypass docker-compose up -d
      - DOCKER_MYSQL_HOST=${MYSQL_HOST:-mysql}
      - DOCKER_MYSQL_PORT=${MYSQL_PORT:-3306}
      - DOCKER_MYSQL_USER=${MYSQL_USER:-zoo}           # 与 mysql 服务的 MYSQL_USER 使用相同变量
      - DOCKER_MYSQL_PASSWORD=${MYSQL_PASSWORD:-zoo123456}  # 与 mysql 服务的 MYSQL_PASSWORD 使用相同变量
      - DOCKER_MYSQL_DATABASE=${MYSQL_DATABASE:-zoo}   # 与 mysql 服务的 MYSQL_DATABASE 使用相同变量
      # Redis 配置（传递给启动脚本，仅在检测到 Redis 服务时使用）
      - DOCKER_REDIS_HOST=${REDIS_HOST:-redis}
      - DOCKER_REDIS_PORT=${REDIS_PORT:-6379}
      - DOCKER_REDIS_PASSWORD=${REDIS_PASSWORD:-}
    entrypoint: ["/app/entrypoint.sh"]
    command: ["/app/bin/zoo", "-c", "/app/configs/zoo.yaml"]
    networks:
      - zoo-network
    # 只有当定义了 mysql 和 redis 服务时才添加依赖
    # 如果不需要 Docker 中的数据库（使用外部数据库），请注释掉下面的 depends_on
    # 同时也可以注释掉上方的 mysql 和 redis 服务定义
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8599/healthz"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  zoo-network:
    driver: bridge

# =============================================================================
# 使用说明：
# 
# 【数据库配置方式】
# 
# 方式1：使用 Docker 中的 MySQL 和 Redis（推荐用于开发/测试）
#   - 保持上方 mysql 和 redis 服务定义不变
#   - 保持 zoo 服务的 depends_on 不变
#   - 应用程序会自动检测并连接到 Docker 中的数据库
#   - 可通过环境变量自定义数据库配置：
#     MYSQL_ROOT_PASSWORD=xxx MYSQL_USER=xxx MYSQL_PASSWORD=xxx docker-compose up -d
#
# 方式2：使用外部 MySQL 和 Redis（推荐用于生产环境）
#   - 注释掉上方的 mysql 和 redis 服务定义（整个服务块）
#   - 注释掉 zoo 服务中的 depends_on 部分
#   - 在 configs/zoo.yaml 中配置外部数据库连接信息
#   - 应用程序会使用配置文件中的数据库配置
#
# 方式3：混合使用（MySQL 用 Docker，Redis 用外部，或反之）
#   - 只注释掉不需要的服务（mysql 或 redis）
#   - 只注释掉 depends_on 中对应的依赖项
#   - 对于 Docker 服务，应用程序会自动连接
#   - 对于外部服务，在 configs/zoo.yaml 中配置
#
# 【部署命令】
# 
# 1. 一键部署:
#    执行: ./deploy.sh
#    或: ./quick-install.sh
# 
# 2. 手动部署:
#    docker-compose up -d
# 
# 【访问地址】
#   - 用户端:     http://localhost:8599/
#   - 管理后台:   http://localhost:8599/web/admin/main/
#   - 健康检查:   http://localhost:8599/healthz
#
# 【数据持久化】
#   - MySQL 数据: ./data/mysql
#   - Redis 数据: ./data/redis
#   - 应用日志:   ./logs
# =============================================================================

